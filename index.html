<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earshot Events</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div class="container mt-2 mb-5">
      <div class="row">
        <div class="col-md-12 root">
           
        </div>
        <div class="text-center" style="margin:auto">
          <img src="./css/Reload-1s-200px.gif" width="50" height="50" class="image_id" class="text-center"/>
          </div>
        </div>
    </div>

    <script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous"></script>
    
    <script>  

      function findGetParameter(parameterName) {
        var result = null,
            tmp = [];
          location.search
            .substr(1)
            .split("&")
            .forEach(function (item) {
              tmp = item.split("=");
              if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
            });
        return result;
      }
      
      function showStatus(props) {
        var capicity = (props.count && props.capacity) ? `<span class="status">${props.count}/${props.capacity}</span>` : "";
        var emoji = (props.status.toLowerCase() == "looking for players") ? `<img src="https://media.tenor.com/images/8b5f93c8693a58f564cf9c247db9e39f/tenor.gif" class="flag" alt="Looking for Players">` : "";
        if (props.status && props.status.trim().length) {
          return `${emoji} <span class="status">(${props.status.toUpperCase()})</span> ${capicity}`;
        }
        return "";
      }
      
      function isValidUrl(string) {
        let url;
  
        try {
          url = new URL(string);
        } catch (_) {
          return null;
        }

        return url.protocol;
      }

      function showCalLinks() {
        let links = "<a href=/events>NOW</a>";
        let sortedLinks = new Map([...firstEvents.entries()].sort((a, b) => a[1] - b[1]));

        sortedLinks.forEach((date, key) => {
          let day = moment(key).format("DD");
          links = links.concat(" | <a href=/events?date=", key, ">", day, "</a>");
        });
        
        let render = `
          <div class="card custom_border_left mt-5" style="border-left-color:red">
            <div class="card-header ak_card_header" style="background:#cccccc">

              <div class="float-left">${currentAdj.format(DISP_FORMAT)}</div>
              <div class="float-right">
                ${links}
              </div>
            </div>
          </div>
          `;
        return render;
      }

      function showImageSlide(imgslider){
         
        let render = `
            <div class="card mt-2  ak_img">
             
            </div>
          `;
        return render;

      }
      
      const colors = [ 'ff9966', '996633', 'cc6633', '669966', '339966', '33cc99', '339999', '339966', '33cc99' ];
      
      // Locations in this list will be sorted first
      const locSorting = ['Twitch'];
 
      let room = findGetParameter('loc');
      let iDate = findGetParameter('date');
      let iTime = findGetParameter('time');
      let urlid = findGetParameter('id');
      let apiurl = "https://sheetdb.io/api/v1/"+ urlid;

      

      // The event time is not UTC, so we will beed to use timeZoneOffset to find the correct time.
      let utc = new Date();
      let currentUtcStr = "".concat(utc.getUTCFullYear(), "/", utc.getUTCMonth()+1, "/", utc.getUTCDate(),
        " ", utc.getUTCHours(), ":", utc.getUTCMinutes(), ":", utc.getUTCSeconds());
      let currentUtc = moment(currentUtcStr);
      const timeZoneOffset = -5;  // EDT
      let currentAdj = currentUtc.add(timeZoneOffset, "hours");

      let TIME_FORMAT = 'MM/DD/YYYY HH:mm';
      let DATE_FORMAT = 'MM/DD/YYYY';
      let DISP_FORMAT = 'MM/DD dddd hh:mm A';
      let date = (iDate == null ? moment(currentAdj).format(DATE_FORMAT) : moment(new Date(iDate)).format(DATE_FORMAT));
      let time = (iTime == null ? moment(currentAdj).format('HH:mm') : moment(new Date(date + ' ' + iTime)).format('HH:mm'));
      let current = moment(new Date(date));
      if ((!iTime && !iDate) || (iTime && iDate)) {
        current = moment(new Date(date + ' ' + time));
      }

      
      var firstEvents = new Map();
      
      var moreLess = 'More';

      $(".image_id").css("display", "block");

      $.ajax({
        // url: "https://api.jsonbin.io/b/5fa2a27dce4aa2289555af31/9",
         //url: "https://sheetdb.io/api/v1/kulkorgjwk4xf",
         url: apiurl,
        //url: "./data-metatopia-2020.json",
        cache: false,
        success: function(response){

          $(".image_id").css("display", "none");

            var todayArray = [];
            var todayArrayNext = [];

           

            response.forEach(q => {
              let data = { 
                code: q.Code,
                name: q.Event, 
                speakers: q.Presenters,
                desc: q.Description,
                start: q.Start,
                end: q.End,
                info: q.Info,
                location: q.Location,
                capacity: q.Capacity,
                count: q.Count,
                images: q.Image,
                status: q.Status,
                link1: q.Link1,
                url1: q.Url1,
                link2: q.Link2,
                url2: q.Url2,
                platform: q.Platform,
                accessInfo: q.AccessInfo,
              };
              
              
              if (data.location && data.name && data.start && data.end) {
                let date = new Date(data.start);
                let dateKey = moment(date).format(DATE_FORMAT);

               

                if (moment(new Date(data.end)) > current && 
                    dateKey == current.format(DATE_FORMAT)) {
                  // This event is for the given day, and is either happening now, or later in the day
                  todayArray.push(data);
                }
              
                // Store the first events of the day to create a summary calendar link
                if (firstEvents.has(dateKey)) {
                  if (date < firstEvents[dateKey]) {
                    firstEvents.set(dateKey, date);
                  }
                } else {
                  firstEvents.set(dateKey, date);
                }
              }
              
            });
            
             
              if(room != null) {
                var todayArrayNext = todayArray.filter(item => item.location.toLowerCase().indexOf(room) > -1);
              }

              
              
              var todayArrayNext = room != null ? todayArrayNext : todayArray;
              // var sortedArray  = todayArrayNext.sort((a,b) => new Date(a.start) - new Date(b.start));
              var sortedArray  = todayArrayNext.sort(function(a, b) {
                const aLoc = locSorting.indexOf(a.location);
                const bLoc = locSorting.indexOf(b.location);
                
                if (aLoc == -1 && bLoc == -1) {
                  return new Date(a.start) - new Date(b.start);
                }
                if (aLoc == -1) {
                  return 1;
                }
                if (bLoc == -1) {
                  return -1;
                }
                return new Date(a.start) - new Date(b.start);
              });

            let randomSliderArray = todayArrayNext.sort(() => Math.random() - 0.5);
            

              var output = sortedArray.reduce(function(result, value) {
                var location = value.location; 
                result[location] = result[location] || []; 
                result[location].push({ 
                  code:value.code,
                  name: value.name, 
                  speakers: value.speakers,
                  desc: value.desc,
                  start: value.start,
                  end: value.end,
                  info: value.info,
                  location: value.location,
                  capacity: value.capacity,
                  images: value.images,
                  count: value.count,
                  status: value.status,
                  link1: value.link1,
                  url1: value.url1,
                  link2: value.link2,
                  url2: value.url2,
                  platform: value.platform,
                  accessInfo: value.accessInfo,
                });
                return result; 
              }, {});
              
             
            
            

              if((Object.keys(output).length === 0 && output.constructor === Object) == false){

                var counter = '';

                let entries = Object.entries(output);

                
                let shownUpnextCount = 0;
                let lastKey = "";
                
                $('.root').append(`${showCalLinks()}`);

                // add image slider
                $('.root').append(
                    `
                    <div class="card mt-2  ak_img">
                      ${randomSliderArray.map(function(galleryValue,index){
                      return`<div class="ak_gallery">
                          <img src="${galleryValue.images}" width="100" height="100">
                          <div class="ak_img_desc">${galleryValue.name}</div>
                       </div>`
                    })}
                    </div>
                    `

                  )
                
                for(let [index, [key, value]] of entries.entries()){
                  color = colors[index % colors.length];
                
                  let button1 = value[0].url1 ? `                            
                    <a href=${`${value[0].url1}`} target="_blank">
                      <button type="button" class="btn btn-outline-light float-right mt-310">${value[0].link1}</button>
                    </a>` : "";
                    
                  let button2 = value[0].url2 ? `                            
                    <a href=${`${value[0].url2}`} target="_blank">
                      <button type="button" class="btn btn-outline-light float-right mt-310">${value[0].link2}</button>
                    </a>` : "";
                    
                  let platform = value[0].platform ? 
                    `
                      <div class="tabletop-sim float-right">${value[0].platform} | ${value[0].accessInfo}</div>
                    ` : "";

                  let isHappeningNowPresent = false;
                  let shownHappeningNowCount = 0;
                  let visibleCount = 0;

                 
                    
                  $('.root').append(  
                      `
                        <div class="card custom_border_left mt-2" style="border-left-color:#${color}">
                          <div class="card-header ak_card_header" style="background:#${color}">

                            <h4 class="card-room d-inline">${key}</h4>
  
                            ${button2}
                            ${button1}
                            
                          </div>
                          
                          ${
                          
                            
                            value.map(function(que,index) {

                              let isHappeningNow = current >= moment(new Date(que.start)) && current < moment(new Date(que.end));
                              
                              let isSameDay =  current.format(DATE_FORMAT) == moment(new Date(que.start)).format(DATE_FORMAT);

                              let isUpNext = moment(new Date(que.start)) >= current;
                              
                              let isPassed = moment(new Date(que.end)) <= current;
                              
                              let hideEvent = (index > shownHappeningNowCount);
                              let showEvent = isHappeningNow || (isUpNext && !hideEvent);
                              if (showEvent) {
                                visibleCount++;
                              }
                              
                              if (lastKey != key) {
                                shownUpnextCount = 0;
                                shownHappeningNowCount = 0;
                                isHappeningNowPresent = false;
                              }
                              if (!isHappeningNow && isSameDay && isUpNext) {
                                shownUpnextCount += 1;
                              }
                              if (isHappeningNow && shownUpnextCount == 0) {
                                isHappeningNowPresent = true;
                                shownHappeningNowCount += 1;
                              }
                              
                              lastKey = key;
                              // console.log(que.name, {isHappeningNow: isHappeningNow, isSameDay: isSameDay, isUpNext: isUpNext, isPassed: isPassed, visibleCount: visibleCount, shownUpnextCount: shownUpnextCount, hideEvent: hideEvent, showEvent: showEvent, shownHappeningNowCount: shownHappeningNowCount, length: value.length, index: index, hasMore: hasMore});

                                return `
                                  
                                  ${shownUpnextCount == 0 && isSameDay && isUpNext && !isHappeningNow ?
                                    `<h5 class="card-title ak_card_subtitle mt-3 ml-3">NO CURRENT EVENT ${index}</h5>`
                                    : ``
                                  }

                                  ${!isPassed && isSameDay ?

                                    `${
                                     `
                                     <div class="${ isHappeningNow && isSameDay ? 'card-body' : 'card-footer ak_card_footer' } ${hideEvent ? `hidden_card_${key.replace(/\s/g, '')}` : '' }" 
                                      style="${showEvent ? 'display:block' : 'display:none'}">

                                      ${isHappeningNow && shownHappeningNowCount < 2 && isSameDay ?
                                        `<h5 class="card-title ak_card_subtitle mt-3">HAPPENING NOW</h5>`
                                        : ``
                                      }
                                      ${!isHappeningNow && isHappeningNowPresent && isUpNext && isSameDay && shownUpnextCount == 1 ?
                                        `<h5 class="card-title ak_card_subtitle mt-3">UP NEXT</h5>`
                                        : ``
                                      }

                                      <span class="card-text ak_room_title">${que.code} - ${que.name}</span>
                                      <span>${showStatus(que)}</span>
                                      <span class="float-right ak_date">${moment(new Date(que.start)).format('dddd hh:mm A')} - ${moment(new Date(que.end)).format('hh:mm A')}</span>
                                      <br>

                                      <b style="color: black !important;">${que.speakers}</b><br>
                                      <div class="ak_room_descp mt-3">
                                        <img class="ak_desc_img" src=${que.images} />
                                        ${que.desc}
                                      </div>
                                      
                                      <div class="info float-left">${que.info}</div>
                                      ${platform}
                                      </div>
                                        
                                      `
                                   }`
                                   
                                    : ``
                                  }
                                  `
                            }).join('')
                        }


                        ${value.length > visibleCount ?
                        `<h6 class="text-center more">
                          <span class="active ${key.replace(/\s/g, '')}" style="cursor:pointer">MORE</span>
                        </h6>`
                        : '' }
                    ` )

                } 

              }
              else {
                $('.root').append(`${showCalLinks()}`);
                $('.root').append(
                ` <br><br><br>
                  <h1 class="text-center">NO EVENTS</h1>
                ` )
              }
              
              $(".active").click(function(){
                var word = $(this).attr("class");

                var lastword = word.replace('active','');

                var str = lastword.replace(/\s/g, '');


                if($.trim($('.'+str).text()) === 'MORE'){
                  $('.'+str).text('LESS');
                }else{
                  $('.'+str).text('MORE');
                }

                $(`.hidden_card_${str}`).slideToggle();
              });
        }
      });

    </script>

    
</body>
</html>